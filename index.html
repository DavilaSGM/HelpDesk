<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mesa de Ayuda</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-bottom: 10px; }
    input, button { padding: 8px; margin: 5px; border: none; cursor: pointer; }
    #btnAll { background-color: #4CAF50; color: white; }
    #btnProc { background-color: orange; color: white; }
    #btnAten { background-color: green; color: white; }
    #btnCanc { background-color: red; color: white; }
    #btnClear { background-color: gray; color: white; }
    #contador { font-size: 18px; margin: 15px 0; font-weight: bold; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .en-proceso { background-color: #fff3cd; }
    .atendido { background-color: #d4edda; }
    .cancelado { background-color: #f8d7da; }
    .graficas { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    canvas { max-width: 300px; height: auto; }
    .resumen-estados { margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap; font-weight: bold; }
    .resumen-item { padding: 8px 12px; border-radius: 5px; color: white; }
    .resumen-proceso { background-color: orange; }
    .resumen-atendido { background-color: green; }
    .resumen-cancelado { background-color: red; }
  </style>
</head>
<body>

<h2>Mesa de Ayuda</h2>

<div>
  <button id="btnAll">Todos</button>
  <button id="btnProc">En Proceso</button>
  <button id="btnAten">Atendido</button>
  <button id="btnCanc">Cancelado</button>
  <input type="text" id="buscar" placeholder="Buscar ticket o palabra clave...">
  <button id="btnClear">Limpiar</button>
</div>

<div id="contador"></div>

<div class="resumen-estados" id="resumenEstados"></div>

<div class="graficas">
  <canvas id="pieChart"></canvas>
  <canvas id="barChart"></canvas>
</div>

<table id="tabla">
  <thead><tr id="thead"></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRY0BZ-pqh9BXOe13dEk5RxFlGiSX1BkeKupM4b1BVtygR8KWuDE4jjEQTSd796v-JSG93fIzHM32Wd/pub?output=csv&gid=922747199";

let rowsOriginal = [], chartPie, chartBar, filtroEstado = "Todos";

const tbody = document.getElementById("tbody");
const thead = document.getElementById("thead");
const contador = document.getElementById("contador");
const resumenEstados = document.getElementById("resumenEstados");
const inputBuscar = document.getElementById("buscar");

// Columnas a mostrar en tabla
const columnasMostrar = [
  "Ticket",
  "Fecha",
  "Tiempo de ticket",
  "Nombre Completo del solicitante",
  "Solicitud",
  "ESTATUS",
  "FECHA DE ATENCIÓN"
];

fetch(URL)
  .then(res => res.text())
  .then(csv => {
    rowsOriginal = csv.trim().split("\n").map(r => r.split(","));
    construirVista();
  })
  .catch(err => console.error("Error cargando CSV:", err));

function construirVista() {
  if (rowsOriginal.length === 0) return;

  const headersOriginal = rowsOriginal[0].map(h => h.trim());
  const idxEstatus = headersOriginal.findIndex(h => h.toLowerCase() === "estatus");
  const idxFecha = headersOriginal.findIndex(h => h.toLowerCase() === "fecha");

  // Índices de las columnas que sí queremos mostrar en la tabla
  const idxMostrar = columnasMostrar.map(c => headersOriginal.findIndex(h => h.toLowerCase() === c.toLowerCase()));

  // Filtrar registros según búsqueda y estado
  let filtradosOriginal = rowsOriginal.slice(1).filter(r => r.length > 0);
  const textoBusqueda = inputBuscar.value.trim().toLowerCase();

  filtradosOriginal = filtradosOriginal.filter(r => {
    const est = (r[idxEstatus] || "").toLowerCase();
    const estadoOk = filtroEstado === "Todos" || est === filtroEstado.toLowerCase();
    const buscaOk = textoBusqueda === "" || r.some(c => (c || "").toLowerCase().includes(textoBusqueda));
    return estadoOk && buscaOk;
  });

  // Ordenar por fecha (más reciente primero)
  filtradosOriginal.sort((a, b) => {
    const fechaA = new Date(a[idxFecha].split("/").reverse().join("-"));
    const fechaB = new Date(b[idxFecha].split("/").reverse().join("-"));
    return fechaB - fechaA;
  });

  // Generar datos para la tabla con solo las columnas visibles
  const headersTabla = idxMostrar.map(i => headersOriginal[i]);
  const rowsTabla = filtradosOriginal.map(r => idxMostrar.map(i => r[i] || "No aplica"));

  // Mostrar encabezados
  thead.innerHTML = headersTabla.map(h => `<th>${h}</th>`).join("");

  // Llenar tabla
  tbody.innerHTML = "";
  rowsTabla.forEach((filaReducida, index) => {
    const tr = document.createElement("tr");
    const est = (filtradosOriginal[index][idxEstatus] || "").toLowerCase();
    if (est.includes("proceso")) tr.classList.add("en-proceso");
    if (est.includes("atendido")) tr.classList.add("atendido");
    if (est.includes("cancelado")) tr.classList.add("cancelado");

    filaReducida.forEach(c => {
      const td = document.createElement("td");
      td.textContent = c && c.trim() !== "" ? c : "No aplica";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Contador
  contador.textContent = `Total: ${filtradosOriginal.length}`;

  // Datos para gráficas y resumen
  const estados = ["En Proceso", "Atendido", "Cancelado"];
  const data = estados.map(e =>
    filtradosOriginal.filter(r => (r[idxEstatus] || "").toLowerCase() === e.toLowerCase()).length
  );

  // Resumen
  resumenEstados.innerHTML = `
    <div class="resumen-item resumen-proceso">En Proceso: ${data[0]}</div>
    <div class="resumen-item resumen-atendido">Atendido: ${data[1]}</div>
    <div class="resumen-item resumen-cancelado">Cancelado: ${data[2]}</div>
  `;

  // Gráfica pastel
  if (chartPie) chartPie.destroy();
  chartPie = new Chart(document.getElementById("pieChart"), {
    type: 'pie',
    data: { labels: estados, datasets: [{ data, backgroundColor: ['orange', 'green', 'red'] }] },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Gráfica barras (cada barra con su etiqueta)
  if (chartBar) chartBar.destroy();
  chartBar = new Chart(document.getElementById("barChart"), {
    type: 'bar',
    data: {
      labels: estados,
      datasets: [{
        label: 'Tickets',
        data: data,
        backgroundColor: ['orange', 'green', 'red']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

// Botones de filtro
document.getElementById("btnAll").onclick = () => { filtroEstado = "Todos"; construirVista(); };
document.getElementById("btnProc").onclick = () => { filtroEstado = "En Proceso"; construirVista(); };
document.getElementById("btnAten").onclick = () => { filtroEstado = "Atendido"; construirVista(); };
document.getElementById("btnCanc").onclick = () => { filtroEstado = "Cancelado"; construirVista(); };
inputBuscar.addEventListener("input", construirVista);
document.getElementById("btnClear").onclick = () => {
  filtroEstado = "Todos";
  inputBuscar.value = "";
  construirVista();
};
</script>

</body>
</html>
