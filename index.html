<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mesa de Ayuda</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-bottom: 10px; }
    input, button { padding: 8px; margin: 5px; border: none; cursor: pointer; }
    #btnAll { background-color: #4CAF50; color: white; }
    #btnProc { background-color: orange; color: white; }
    #btnAten { background-color: green; color: white; }
    #btnCanc { background-color: red; color: white; }
    #btnClear { background-color: gray; color: white; }
    #contador { font-size: 18px; margin: 15px 0; font-weight: bold; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .en-proceso { background-color: #fff3cd; }
    .atendido { background-color: #d4edda; }
    .cancelado { background-color: #f8d7da; }
    .graficas { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    canvas { max-width: 300px; height: auto; }
    .resumen-estados { margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap; font-weight: bold; }
    .resumen-item { padding: 8px 12px; border-radius: 5px; color: white; }
    .resumen-proceso { background-color: orange; }
    .resumen-atendido { background-color: green; }
    .resumen-cancelado { background-color: red; }
  </style>
</head>
<body>

<h2>Mesa de Ayuda</h2>

<div>
  <button id="btnAll">Todos</button>
  <button id="btnProc">En Proceso</button>
  <button id="btnAten">Atendido</button>
  <button id="btnCanc">Cancelado</button>
  <input type="text" id="buscar" placeholder="Buscar ticket o palabra clave...">
  <button id="btnClear">Limpiar</button>
</div>

<div id="contador"></div>

<div class="resumen-estados" id="resumenEstados"></div>

<div class="graficas">
  <canvas id="pieChart"></canvas>
  <canvas id="barChart"></canvas>
</div>

<table id="tabla">
  <thead><tr id="thead"></tr></thead>
  <tbody id="tbody"></tbody>
</table>

<script>
const URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRY0BZ-pqh9BXOe13dEk5RxFlGiSX1BkeKupM4b1BVtygR8KWuDE4jjEQTSd796v-JSG93fIzHM32Wd/pub?output=csv&gid=922747199";

let registros = [];           // objetos {columna: valor} del CSV
let keyMap = {};              // mapa de nombre normalizado -> nombre real
let filtroEstado = "Todos";   // "Todos" | "En Proceso" | "Atendido" | "Cancelado"

const columnasMostrar = [
  "Ticket",
  "Fecha",
  "Tiempo de ticket",
  "Nombre Completo del solicitante",
  "Solicitud",
  "ESTATUS",
  "FECHA DE ATENCIÓN"
];

const tbody = document.getElementById("tbody");
const thead = document.getElementById("thead");
const contador = document.getElementById("contador");
const resumenEstados = document.getElementById("resumenEstados");
const inputBuscar = document.getElementById("buscar");

const norm = s => (s ?? "").toString().trim().toLowerCase();
const getVal = (row, desired) => row[keyMap[norm(desired)]] ?? "";

function parseFecha(str) {
  const s = (str || "").toString().trim();
  if (!s) return new Date(0);
  // dd/mm/yyyy o d/m/yy
  if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)) {
    let [d,m,y] = s.split("/");
    if (y.length === 2) y = "20" + y;
    return new Date(+y, +m - 1, +d);
  }
  // yyyy-mm-dd (o con hora)
  if (/^\d{4}-\d{1,2}-\d{1,2}/.test(s)) {
    return new Date(s);
  }
  // fallback (Date intenta parsear best-effort)
  return new Date(s);
}

function cargar() {
  Papa.parse(URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      const headers = results.meta.fields || [];
      // construir mapa de headers normalizados -> header real
      keyMap = {};
      headers.forEach(h => { keyMap[norm(h)] = h; });
      // asegurar que tenemos las columnas necesarias (aunque cambie mayúsculas)
      columnasMostrar.forEach(des => {
        if (!keyMap[norm(des)]) {
          // si falta, crea una entrada vacía para evitar errores de acceso
          keyMap[norm(des)] = des; 
        }
      });

      // Filtrar filas realmente vacías y quedarnos con registros que tengan Ticket o Solicitud
      registros = (results.data || []).filter(obj => {
        const tieneContenido = Object.values(obj).some(v => (v ?? "").toString().trim() !== "");
        const tieneClave = (obj[keyMap[norm("Ticket")]] ?? "").toString().trim() !== "" ||
                           (obj[keyMap[norm("Solicitud")]] ?? "").toString().trim() !== "";
        return tieneContenido && tieneClave;
      });

      construirVista();
    },
    error: (err) => console.error("Error parseando CSV:", err)
  });
}

function construirVista() {
  if (!registros.length) {
    thead.innerHTML = ""; tbody.innerHTML = "";
    contador.textContent = "Total: 0";
    resumenEstados.innerHTML = "";
    return;
  }

  // Encabezados de la tabla (en el orden solicitado)
  thead.innerHTML = columnasMostrar.map(h => `<th>${h}</th>`).join("");

  // Texto de búsqueda
  const q = norm(inputBuscar.value);

  // Filtro por estado + búsqueda sobre columnas visibles
  const filtrados = registros.filter(row => {
    const est = norm(getVal(row, "ESTATUS"));
    const estadoOk = (filtroEstado === "Todos") || (est === norm(filtroEstado));
    const textoOk = q === "" || columnasMostrar.some(col => norm(getVal(row, col)).includes(q));
    return estadoOk && textoOk;
  });

  // Orden por Fecha descendente (más reciente primero)
  filtrados.sort((a, b) => parseFecha(getVal(b, "Fecha")) - parseFecha(getVal(a, "Fecha")));

  // Render tabla
  tbody.innerHTML = "";
  filtrados.forEach(row => {
    const tr = document.createElement("tr");
    const est = norm(getVal(row, "ESTATUS"));
    if (est.includes("proceso")) tr.classList.add("en-proceso");
    else if (est.includes("atendido")) tr.classList.add("atendido");
    else if (est.includes("cancelado")) tr.classList.add("cancelado");

    columnasMostrar.forEach(col => {
      const val = (getVal(row, col) || "").toString().trim();
      const td = document.createElement("td");
      td.textContent = val !== "" ? val : "No aplica";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Contador
  contador.textContent = `Total: ${filtrados.length}`;

  // Conteos por estado (basados en lo Filtrado)
  const estados = ["En Proceso", "Atendido", "Cancelado"];
  const data = estados.map(e =>
    filtrados.filter(r => norm(getVal(r, "ESTATUS")) === norm(e)).length
  );

  // Resumen
  resumenEstados.innerHTML = `
    <div class="resumen-item resumen-proceso">En Proceso: ${data[0]}</div>
    <div class="resumen-item resumen-atendido">Atendido: ${data[1]}</div>
    <div class="resumen-item resumen-cancelado">Cancelado: ${data[2]}</div>
  `;

  // Gráfica pastel
  if (window.chartPie) window.chartPie.destroy();
  window.chartPie = new Chart(document.getElementById("pieChart"), {
    type: 'pie',
    data: { labels: estados, datasets: [{ data, backgroundColor: ['orange', 'green', 'red'] }] },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Gráfica de barras (3 barras con su etiqueta)
  if (window.chartBar) window.chartBar.destroy();
  window.chartBar = new Chart(document.getElementById("barChart"), {
    type: 'bar',
    data: {
      labels: estados,
      datasets: [{
        label: 'Tickets',
        data: data,
        backgroundColor: ['orange', 'green', 'red']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

// Eventos de UI
document.getElementById("btnAll").onclick = () => { filtroEstado = "Todos"; construirVista(); };
document.getElementById("btnProc").onclick = () => { filtroEstado = "En Proceso"; construirVista(); };
document.getElementById("btnAten").onclick = () => { filtroEstado = "Atendido"; construirVista(); };
document.getElementById("btnCanc").onclick = () => { filtroEstado = "Cancelado"; construirVista(); };
document.getElementById("btnClear").onclick = () => {
  filtroEstado = "Todos";
  inputBuscar.value = "";
  construirVista();
};
inputBuscar.addEventListener("input", construirVista);

// Cargar datos
cargar();
</script>

</body>
</html>
